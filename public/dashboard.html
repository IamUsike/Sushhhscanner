<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Risk Visualization Dashboard</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            overflow-x: hidden;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .dashboard-header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .dashboard-header .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255,255,255,0.1);
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }

        .status-item {
            display: flex;
            align-items: center;
            color: white;
            font-weight: 500;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        .status-indicator.connected {
            background: #2ecc71;
        }

        .status-indicator.disconnected {
            background: #e74c3c;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto auto;
            gap: 20px;
            margin-bottom: 30px;
        }

        .dashboard-panel {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .dashboard-panel:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .panel-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
        }

        .panel-title .icon {
            margin-right: 10px;
            font-size: 1.6rem;
        }

        .panel-controls {
            display: flex;
            gap: 10px;
        }

        .control-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            background: #3498db;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .control-btn:hover {
            background: #2980b9;
        }

        .control-btn.active {
            background: #e74c3c;
        }

        .metrics-grid {
            grid-column: 1 / -1;
        }

        .network-map {
            grid-column: 1 / -1;
            min-height: 500px;
        }

        .heatmap-panel {
            min-height: 400px;
        }

        .timeline-panel {
            min-height: 400px;
        }

        .insights-panel {
            grid-column: 1 / -1;
            max-height: 400px;
            overflow-y: auto;
        }

        .visualization-container {
            width: 100%;
            height: 100%;
            min-height: 300px;
        }

        .risk-tooltip {
            position: absolute;
            padding: 12px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            border-radius: 8px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            max-width: 250px;
            line-height: 1.4;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .insight-item {
            background: #f8f9fa;
            border-left: 4px solid #3498db;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 0 8px 8px 0;
            transition: background 0.3s ease;
        }

        .insight-item:hover {
            background: #e9ecef;
        }

        .insight-item.high-priority {
            border-left-color: #e74c3c;
        }

        .insight-item.medium-priority {
            border-left-color: #f39c12;
        }

        .insight-item.low-priority {
            border-left-color: #2ecc71;
        }

        .insight-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 8px;
        }

        .insight-type {
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .insight-confidence {
            background: #3498db;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .insight-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .insight-description {
            color: #5a6c7d;
            font-size: 0.95rem;
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .insight-recommendation {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.9rem;
            color: #27ae60;
            border: 1px solid #d5e9d5;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            color: #e74c3c;
            text-align: center;
            padding: 20px;
            background: #fdf2f2;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            margin: 10px 0;
        }

        .legend {
            font-size: 12px;
        }

        .legend-item {
            cursor: pointer;
            transition: opacity 0.3s ease;
        }

        .legend-item:hover {
            opacity: 0.7;
        }

        .metric-card {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            filter: brightness(1.1);
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .status-bar {
                flex-direction: column;
                gap: 10px;
            }
            
            .dashboard-header h1 {
                font-size: 2rem;
            }
            
            .panel-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }

        /* Dark theme support */
        @media (prefers-color-scheme: dark) {
            .dashboard-panel {
                background: rgba(44, 62, 80, 0.95);
                color: #ecf0f1;
            }
            
            .panel-title {
                color: #ecf0f1;
            }
            
            .insight-item {
                background: #34495e;
                color: #ecf0f1;
            }
            
            .insight-description {
                color: #bdc3c7;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <div class="dashboard-header">
            <h1>üß† AI/ML Risk Visualization Dashboard</h1>
            <div class="subtitle">Real-time API Security Risk Assessment with TensorFlow.js</div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-item">
                <div class="status-indicator connected" id="connectionStatus"></div>
                <span id="connectionText">Connected to Risk Engine</span>
            </div>
            <div class="status-item">
                <span id="lastUpdate">Last Update: --:--</span>
            </div>
            <div class="status-item">
                <span id="clientCount">Clients: 1</span>
            </div>
        </div>

        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Metrics Panel -->
            <div class="dashboard-panel metrics-grid">
                <div class="panel-header">
                    <div class="panel-title">
                        <span class="icon">üìä</span>
                        Risk Metrics Overview
                    </div>
                    <div class="panel-controls">
                        <button class="control-btn" onclick="refreshMetrics()">üîÑ Refresh</button>
                    </div>
                </div>
                <div class="visualization-container" id="metricsContainer"></div>
            </div>

            <!-- Network Risk Map -->
            <div class="dashboard-panel network-map">
                <div class="panel-header">
                    <div class="panel-title">
                        <span class="icon">üó∫Ô∏è</span>
                        Interactive Risk Network Map
                    </div>
                    <div class="panel-controls">
                        <button class="control-btn" onclick="toggleRealTime()" id="realTimeBtn">‚ñ∂Ô∏è Real-time</button>
                        <button class="control-btn" onclick="resetZoom()">üîç Reset Zoom</button>
                    </div>
                </div>
                <div class="visualization-container" id="networkContainer"></div>
            </div>

            <!-- Risk Heatmap -->
            <div class="dashboard-panel heatmap-panel">
                <div class="panel-header">
                    <div class="panel-title">
                        <span class="icon">üå°Ô∏è</span>
                        Risk Heatmap
                    </div>
                    <div class="panel-controls">
                        <button class="control-btn" onclick="refreshHeatmap()">üîÑ Update</button>
                    </div>
                </div>
                <div class="visualization-container" id="heatmapContainer"></div>
            </div>

            <!-- Timeline Chart -->
            <div class="dashboard-panel timeline-panel">
                <div class="panel-header">
                    <div class="panel-title">
                        <span class="icon">üìà</span>
                        Risk Timeline
                    </div>
                    <div class="panel-controls">
                        <button class="control-btn" onclick="refreshTimeline()">üîÑ Update</button>
                    </div>
                </div>
                <div class="visualization-container" id="timelineContainer"></div>
            </div>

            <!-- AI Insights Panel -->
            <div class="dashboard-panel insights-panel">
                <div class="panel-header">
                    <div class="panel-title">
                        <span class="icon">ü§ñ</span>
                        AI/ML Security Insights
                    </div>
                    <div class="panel-controls">
                        <button class="control-btn" onclick="refreshInsights()">üß† Generate</button>
                    </div>
                </div>
                <div id="insightsContainer">
                    <div class="loading-spinner"></div>
                    Loading AI insights...
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // Global state
        let socket;
        let visualizations = {};
        let realTimeEnabled = false;
        let lastUpdateTime = new Date();

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeWebSocket();
            initializeVisualizations();
            loadInitialData();
        });

        // WebSocket connection
        function initializeWebSocket() {
            socket = io();

            socket.on('connect', function() {
                updateConnectionStatus(true);
                console.log('Connected to dashboard server');
            });

            socket.on('disconnect', function() {
                updateConnectionStatus(false);
                console.log('Disconnected from dashboard server');
            });

            socket.on('real-time-update', function(data) {
                handleRealTimeUpdate(data);
            });

            socket.on('heatmap-data', function(data) {
                updateHeatmap(data.data);
            });

            socket.on('insights-data', function(data) {
                updateInsights(data.data);
            });

            socket.on('metrics-data', function(data) {
                updateMetrics(data.data);
            });

            socket.on('error', function(error) {
                showError(error.message);
            });
        }

        // Initialize D3.js visualizations
        function initializeVisualizations() {
            // Import visualization engine would go here
            // For now, we'll create simplified D3 visualizations
            
            console.log('Initializing D3.js visualizations...');
        }

        // Load initial data
        async function loadInitialData() {
            try {
                await Promise.all([
                    refreshMetrics(),
                    refreshHeatmap(),
                    refreshTimeline(),
                    refreshInsights()
                ]);
            } catch (error) {
                showError('Failed to load initial data: ' + error.message);
            }
        }

        // API calls
        async function fetchAPI(endpoint) {
            const response = await fetch(`/api${endpoint}`);
            if (!response.ok) {
                throw new Error(`API error: ${response.statusText}`);
            }
            return response.json();
        }

        // Refresh functions
        async function refreshMetrics() {
            try {
                const response = await fetchAPI('/risk/metrics');
                updateMetrics(response.data);
            } catch (error) {
                showError('Failed to refresh metrics: ' + error.message);
            }
        }

        async function refreshHeatmap() {
            try {
                const response = await fetchAPI('/risk/heatmap');
                updateHeatmap(response.data);
            } catch (error) {
                showError('Failed to refresh heatmap: ' + error.message);
            }
        }

        async function refreshTimeline() {
            try {
                const response = await fetchAPI('/risk/timeline');
                updateTimeline(response.data);
            } catch (error) {
                showError('Failed to refresh timeline: ' + error.message);
            }
        }

        async function refreshInsights() {
            try {
                document.getElementById('insightsContainer').innerHTML = '<div class="loading-spinner"></div>Generating AI insights...';
                const response = await fetchAPI('/risk/insights');
                updateInsights(response.data);
            } catch (error) {
                showError('Failed to refresh insights: ' + error.message);
            }
        }

        // Update functions
        function updateMetrics(metrics) {
            const container = d3.select('#metricsContainer');
            container.selectAll('*').remove();

            const width = 800;
            const height = 200;
            const cardWidth = 140;
            const cardHeight = 100;
            const padding = 15;

            const svg = container.append('svg')
                .attr('width', width)
                .attr('height', height);

            const metricsData = [
                { label: 'Total Vulns', value: metrics.totalVulnerabilities, color: '#3498db', icon: 'üîç' },
                { label: 'Critical', value: metrics.criticalCount, color: '#e74c3c', icon: 'üö®' },
                { label: 'High', value: metrics.highCount, color: '#e67e22', icon: '‚ö†Ô∏è' },
                { label: 'Medium', value: metrics.mediumCount, color: '#f1c40f', icon: 'üìä' },
                { label: 'Low', value: metrics.lowCount, color: '#2ecc71', icon: '‚úÖ' },
                { label: 'Avg Risk', value: `${(metrics.averageRiskScore * 100).toFixed(1)}%`, color: '#9b59b6', icon: 'üìà' }
            ];

            const cards = svg.selectAll('.metric-card')
                .data(metricsData)
                .enter().append('g')
                .attr('class', 'metric-card')
                .attr('transform', (d, i) => `translate(${i * (cardWidth + padding) + padding}, 20)`);

            // Card background
            cards.append('rect')
                .attr('width', cardWidth)
                .attr('height', cardHeight)
                .attr('rx', 8)
                .attr('ry', 8)
                .attr('fill', '#f8f9fa')
                .attr('stroke', d => d.color)
                .attr('stroke-width', 2);

            // Card value
            cards.append('text')
                .attr('x', cardWidth / 2)
                .attr('y', 35)
                .attr('text-anchor', 'middle')
                .attr('font-size', '18px')
                .attr('font-weight', 'bold')
                .attr('fill', d => d.color)
                .text(d => d.value);

            // Card label
            cards.append('text')
                .attr('x', cardWidth / 2)
                .attr('y', 55)
                .attr('text-anchor', 'middle')
                .attr('font-size', '12px')
                .attr('fill', '#7f8c8d')
                .text(d => d.label);

            // Card icon
            cards.append('text')
                .attr('x', cardWidth / 2)
                .attr('y', 80)
                .attr('text-anchor', 'middle')
                .attr('font-size', '16px')
                .text(d => d.icon);

            updateLastUpdateTime();
        }

        function updateHeatmap(heatmapData) {
            const container = d3.select('#heatmapContainer');
            container.selectAll('*').remove();

            const margin = { top: 40, right: 40, bottom: 60, left: 120 };
            const width = 400 - margin.left - margin.right;
            const height = 300 - margin.bottom - margin.top;

            const svg = container.append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom);

            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const methods = Array.from(new Set(heatmapData.map(d => d.method)));
            const endpoints = Array.from(new Set(heatmapData.map(d => d.endpoint)));

            const xScale = d3.scaleBand()
                .domain(methods)
                .range([0, width])
                .padding(0.1);

            const yScale = d3.scaleBand()
                .domain(endpoints)
                .range([0, height])
                .padding(0.1);

            const colorScale = d3.scaleLinear()
                .domain([0, 0.3, 0.6, 0.8, 1])
                .range(['#2ecc71', '#f1c40f', '#e67e22', '#e74c3c', '#8e44ad']);

            // Create heatmap cells
            g.selectAll('.heatmap-cell')
                .data(heatmapData)
                .enter().append('rect')
                .attr('class', 'heatmap-cell')
                .attr('x', d => xScale(d.method))
                .attr('y', d => yScale(d.endpoint))
                .attr('width', xScale.bandwidth())
                .attr('height', yScale.bandwidth())
                .attr('fill', d => colorScale(d.riskScore))
                .attr('stroke', '#fff')
                .attr('stroke-width', 1);

            // Add cell values
            g.selectAll('.heatmap-text')
                .data(heatmapData)
                .enter().append('text')
                .attr('class', 'heatmap-text')
                .attr('x', d => xScale(d.method) + xScale.bandwidth() / 2)
                .attr('y', d => yScale(d.endpoint) + yScale.bandwidth() / 2)
                .attr('text-anchor', 'middle')
                .attr('dy', '.35em')
                .attr('font-size', '10px')
                .attr('font-weight', 'bold')
                .attr('fill', d => d.riskScore > 0.5 ? '#fff' : '#000')
                .text(d => `${(d.riskScore * 100).toFixed(0)}%`);

            // Add axes
            g.append('g')
                .attr('class', 'x-axis')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(xScale));

            g.append('g')
                .attr('class', 'y-axis')
                .call(d3.axisLeft(yScale))
                .selectAll('text')
                .style('font-size', '10px');

            updateLastUpdateTime();
        }

        function updateTimeline(timelineData) {
            const container = d3.select('#timelineContainer');
            container.selectAll('*').remove();

            const margin = { top: 20, right: 40, bottom: 40, left: 50 };
            const width = 400 - margin.left - margin.right;
            const height = 300 - margin.top - margin.bottom;

            const svg = container.append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom);

            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            // Convert timestamp strings to Date objects
            timelineData.forEach(d => {
                d.timestamp = new Date(d.timestamp);
            });

            const xScale = d3.scaleTime()
                .domain(d3.extent(timelineData, d => d.timestamp))
                .range([0, width]);

            const yScale = d3.scaleLinear()
                .domain([0, d3.max(timelineData, d => d.value)])
                .range([height, 0]);

            const line = d3.line()
                .x(d => xScale(d.timestamp))
                .y(d => yScale(d.value))
                .curve(d3.curveMonotoneX);

            // Group data by category
            const categories = Array.from(new Set(timelineData.map(d => d.category)));
            const colorScale = d3.scaleOrdinal(d3.schemeCategory10).domain(categories);

            categories.forEach(category => {
                const categoryData = timelineData.filter(d => d.category === category);

                g.append('path')
                    .datum(categoryData)
                    .attr('fill', 'none')
                    .attr('stroke', colorScale(category))
                    .attr('stroke-width', 2)
                    .attr('d', line);
            });

            // Add axes
            g.append('g')
                .attr('class', 'x-axis')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(xScale));

            g.append('g')
                .attr('class', 'y-axis')
                .call(d3.axisLeft(yScale));

            updateLastUpdateTime();
        }

        function updateInsights(insights) {
            const container = document.getElementById('insightsContainer');
            
            if (!insights || insights.length === 0) {
                container.innerHTML = '<div class="error-message">No AI insights available</div>';
                return;
            }

            const insightsHtml = insights.map(insight => `
                <div class="insight-item ${insight.severity.toLowerCase()}-priority">
                    <div class="insight-header">
                        <span class="insight-type">${insight.type}</span>
                        <span class="insight-confidence">${(insight.confidence * 100).toFixed(0)}%</span>
                    </div>
                    <div class="insight-title">${insight.title}</div>
                    <div class="insight-description">${insight.description}</div>
                    <div class="insight-recommendation">üí° ${insight.recommendation}</div>
                </div>
            `).join('');

            container.innerHTML = insightsHtml;
            updateLastUpdateTime();
        }

        // Utility functions
        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('connectionStatus');
            const text = document.getElementById('connectionText');
            
            if (connected) {
                indicator.className = 'status-indicator connected';
                text.textContent = 'Connected to Risk Engine';
            } else {
                indicator.className = 'status-indicator disconnected';
                text.textContent = 'Disconnected from Risk Engine';
            }
        }

        function updateLastUpdateTime() {
            lastUpdateTime = new Date();
            document.getElementById('lastUpdate').textContent = 
                'Last Update: ' + lastUpdateTime.toLocaleTimeString();
        }

        function handleRealTimeUpdate(data) {
            console.log('Real-time update received:', data);
            
            if (data.type === 'metrics') {
                updateMetrics(data.data);
            } else if (data.type === 'insights') {
                updateInsights(data.data);
            }
        }

        function toggleRealTime() {
            realTimeEnabled = !realTimeEnabled;
            const btn = document.getElementById('realTimeBtn');
            
            if (realTimeEnabled) {
                btn.textContent = '‚è∏Ô∏è Pause';
                btn.classList.add('active');
                socket.emit('subscribe', 'real-time-updates');
            } else {
                btn.textContent = '‚ñ∂Ô∏è Real-time';
                btn.classList.remove('active');
                socket.emit('unsubscribe', 'real-time-updates');
            }
        }

        function resetZoom() {
            // Reset zoom functionality would be implemented here
            console.log('Reset zoom triggered');
        }

        function showError(message) {
            console.error('Dashboard error:', message);
            // You could show a toast notification here
        }

        // Auto-refresh every 30 seconds
        setInterval(() => {
            if (!realTimeEnabled) {
                refreshMetrics();
            }
        }, 30000);
    </script>
</body>
</html> 