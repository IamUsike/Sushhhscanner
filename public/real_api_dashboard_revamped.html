<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõ°Ô∏è CywAyz Enterprise Security Dashboard v2.0</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Modern Color Palette */
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            --danger-gradient: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            --info-gradient: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            
            /* Glass Morphism */
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-bg-strong: rgba(255, 255, 255, 0.15);
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            --glass-shadow-hover: 0 12px 40px rgba(31, 38, 135, 0.5);
            
            /* Dark Theme Variables */
            --bg-primary: #0f0f23;
            --bg-secondary: #1a1a2e;
            --bg-tertiary: #16213e;
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --text-muted: #6c757d;
            
            /* Modern Spacing */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-2xl: 3rem;
            
            /* Border Radius */
            --radius-sm: 0.5rem;
            --radius-md: 0.75rem;
            --radius-lg: 1rem;
            --radius-xl: 1.5rem;
            --radius-2xl: 2rem;
            
            /* Transitions */
            --transition-fast: 0.15s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.5s ease;
            
            /* Z-Index Scale */
            --z-dropdown: 1000;
            --z-sticky: 1020;
            --z-fixed: 1030;
            --z-modal-backdrop: 1040;
            --z-modal: 1050;
            --z-popover: 1060;
            --z-tooltip: 1070;
            --z-toast: 1080;
        }
        
        /* Global Reset & Base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html {
            scroll-behavior: smooth;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            font-feature-settings: 'cv11', 'ss01';
            font-variation-settings: 'slnt' 0;
        }
        
        /* Advanced Utility Classes */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 var(--spacing-lg);
        }
        
        .grid {
            display: grid;
            gap: var(--spacing-lg);
        }
        
        .flex {
            display: flex;
        }
        
        .flex-col {
            flex-direction: column;
        }
        
        .items-center {
            align-items: center;
        }
        
        .justify-between {
            justify-content: space-between;
        }
        
        .gap-2 {
            gap: var(--spacing-sm);
        }
        
        .gap-4 {
            gap: var(--spacing-md);
        }
        
        /* Modern Card System */
        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-xl);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            padding: var(--spacing-xl);
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            opacity: 0;
            transition: opacity var(--transition-normal);
        }
        
        .card:hover {
            transform: translateY(-8px);
            box-shadow: var(--glass-shadow-hover);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .card:hover::before {
            opacity: 1;
        }
        
        .card-elevated {
            background: var(--glass-bg-strong);
            border: 1px solid rgba(255, 255, 255, 0.25);
        }
        
        .card-compact {
            padding: var(--spacing-lg);
        }
        
        /* Modern Typography */
        .heading-1 {
            font-size: clamp(2rem, 5vw, 3.5rem);
            font-weight: 800;
            line-height: 1.2;
            background: linear-gradient(135deg, #fff, #e2e8f0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: var(--spacing-md);
        }
        
        .heading-2 {
            font-size: clamp(1.5rem, 3vw, 2.25rem);
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: var(--spacing-md);
        }
        
        .heading-3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-sm);
        }
        
        .text-muted {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        /* Advanced Button System */
        .btn {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all var(--transition-normal);
            text-decoration: none;
            outline: none;
            overflow: hidden;
            user-select: none;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left var(--transition-slow);
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn-primary {
            background: var(--success-gradient);
            color: white;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.4);
        }
        
        .btn-secondary {
            background: var(--secondary-gradient);
            color: white;
            box-shadow: 0 4px 15px rgba(240, 147, 251, 0.3);
        }
        
        .btn-danger {
            background: var(--danger-gradient);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid var(--glass-border);
            color: var(--text-primary);
        }
        
        .btn-outline:hover {
            background: var(--glass-bg);
            border-color: rgba(255, 255, 255, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
        
        .btn-lg {
            padding: 1rem 2rem;
            font-size: 1.1rem;
        }
        
        /* Advanced Form Controls */
        .form-group {
            margin-bottom: var(--spacing-lg);
        }
        
        .form-label {
            display: block;
            color: var(--text-primary);
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
            font-size: 0.9rem;
        }
        
        .form-control {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-md);
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            font-size: 1rem;
            transition: all var(--transition-normal);
            backdrop-filter: blur(10px);
        }
        
        .form-control:focus {
            outline: none;
            border-color: #4facfe;
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 0 4px rgba(79, 172, 254, 0.1);
            transform: translateY(-1px);
        }
        
        .form-control::placeholder {
            color: var(--text-muted);
        }
        
        /* Modern Checkbox/Radio */
        .checkbox-group, .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }
        
        .checkbox-item, .radio-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            cursor: pointer;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            transition: all var(--transition-normal);
        }
        
        .checkbox-item:hover, .radio-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .checkbox-item input[type="checkbox"], .radio-item input[type="radio"] {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: var(--radius-sm);
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all var(--transition-normal);
            position: relative;
        }
        
        .radio-item input[type="radio"] {
            border-radius: 50%;
        }
        
        .checkbox-item input[type="checkbox"]:checked, .radio-item input[type="radio"]:checked {
            background: var(--success-gradient);
            border-color: #4facfe;
        }
        
        .checkbox-item input[type="checkbox"]:checked::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        .radio-item input[type="radio"]:checked::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
        }
        
        /* Layout Grid */
        .dashboard-grid {
            display: grid;
            grid-template-areas: 
                "header header header header"
                "controls controls progress progress"
                "realtime realtime analytics analytics"
                "network network network network"
                "results results results results";
            grid-template-columns: repeat(4, 1fr);
            gap: var(--spacing-lg);
            padding: var(--spacing-lg);
        }
        
        .header-section { grid-area: header; }
        .controls-section { grid-area: controls; }
        .progress-section { grid-area: progress; }
        .realtime-section { grid-area: realtime; }
        .analytics-section { grid-area: analytics; }
        .network-section { grid-area: network; }
        .results-section { grid-area: results; }
        
        /* Header Section */
        .header-section {
            text-align: center;
            padding: var(--spacing-2xl);
        }
        
        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--glass-bg);
            border-radius: var(--radius-lg);
            margin-top: var(--spacing-md);
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4CAF50;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
            100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
        }
        
        /* Progress Section */
        .progress-bar {
            width: 100%;
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-lg);
            overflow: hidden;
            margin: var(--spacing-md) 0;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--success-gradient);
            border-radius: var(--radius-lg);
            transition: width 0.8s ease;
            position: relative;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* Phase Timeline */
        .phase-timeline {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: var(--spacing-xl) 0;
            position: relative;
        }
        
        .timeline-line {
            position: absolute;
            top: 50%;
            left: 10%;
            right: 10%;
            height: 2px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 1px;
            z-index: 1;
        }
        
        .timeline-progress {
            height: 100%;
            background: var(--success-gradient);
            border-radius: 1px;
            transition: width 0.8s ease;
        }
        
        .phase-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 2;
            position: relative;
        }
        
        .phase-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--glass-bg);
            border: 3px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: var(--spacing-sm);
            transition: all var(--transition-normal);
        }
        
        .phase-icon.active {
            background: var(--success-gradient);
            border-color: rgba(255, 255, 255, 0.5);
            animation: bounce 1s ease-in-out infinite;
            transform: scale(1.1);
        }
        
        .phase-icon.complete {
            background: var(--success-gradient);
            border-color: rgba(255, 255, 255, 0.4);
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: scale(1.1) translateY(0); }
            40% { transform: scale(1.1) translateY(-8px); }
            60% { transform: scale(1.1) translateY(-4px); }
        }
        
        .phase-label {
            color: var(--text-primary);
            font-size: 0.875rem;
            font-weight: 600;
            text-align: center;
        }
        
        /* Statistics Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
        }
        
        .stat-card {
            padding: var(--spacing-lg);
            background: var(--glass-bg);
            border-radius: var(--radius-lg);
            border: 1px solid var(--glass-border);
            text-align: center;
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.05) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }
        
        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
            position: relative;
            z-index: 2;
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
            position: relative;
            z-index: 2;
        }
        
        .stat-change {
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: var(--spacing-xs);
            position: relative;
            z-index: 2;
        }
        
        .stat-change.positive {
            color: #4CAF50;
        }
        
        .stat-change.negative {
            color: #f44336;
        }
        
        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
        }
        
        .chart-canvas {
            width: 100% !important;
            height: 100% !important;
        }
        
        /* Activity Feed */
        .activity-feed {
            /* max-height: 400px; */ /* Removed to allow expansion */
            overflow-y: auto;
            padding-right: var(--spacing-sm);
            flex-grow: 1; /* Allow it to grow and fill space */
        }
        
        .activity-feed::-webkit-scrollbar {
            width: 6px;
        }
        
        .activity-feed::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .activity-feed::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }
        
        .activity-item {
            display: flex;
            align-items: flex-start;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-sm);
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-md);
            border-left: 3px solid #4facfe;
            transition: all var(--transition-normal);
            animation: slideInLeft 0.5s ease-out;
        }
        
        .activity-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--success-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
            flex-shrink: 0;
        }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-message {
            color: var(--text-primary);
            font-weight: 500;
            margin-bottom: var(--spacing-xs);
        }
        
        .activity-time {
            color: var(--text-muted);
            font-size: 0.8rem;
        }
        
        /* Results Section */
        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-lg);
        }
        
        .result-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-sm);
            border-left: 4px solid #4facfe;
            transition: all var(--transition-normal);
        }
        
        .result-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        
        .result-item.critical {
            border-left-color: #ff6b6b;
        }
        
        .result-item.high {
            border-left-color: #feca57;
        }
        
        .result-item.medium {
            border-left-color: #48dbfb;
        }
        
        .result-item.low {
            border-left-color: #4CAF50;
        }
        
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
        }
        
        .result-title {
            color: var(--text-primary);
            font-weight: 600;
            flex: 1;
        }
        
        .result-badge {
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-lg);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .result-badge.critical {
            background: #ff6b6b;
            color: white;
        }
        
        .result-badge.high {
            background: #feca57;
            color: white;
        }
        
        .result-badge.medium {
            background: #48dbfb;
            color: white;
        }
        
        .result-badge.low {
            background: #4CAF50;
            color: white;
        }
        
        .result-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        /* Modern Notifications */
        .notification {
            position: fixed;
            top: var(--spacing-lg);
            right: var(--spacing-lg);
            background: var(--glass-bg-strong);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-lg);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            color: var(--text-primary);
            z-index: var(--z-toast);
            transform: translateX(400px);
            transition: transform var(--transition-normal);
            min-width: 320px;
            max-width: 400px;
            padding: var(--spacing-lg);
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            border-left: 4px solid #4CAF50;
        }
        
        .notification.error {
            border-left: 4px solid #ff6b6b;
        }
        
        .notification.warning {
            border-left: 4px solid #feca57;
        }
        
        .notification.info {
            border-left: 4px solid #48dbfb;
        }
        
        /* Loading States */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 15, 35, 0.9);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: var(--z-modal);
            visibility: hidden;
            opacity: 0;
            transition: all var(--transition-normal);
        }
        
        .loading-overlay.show {
            visibility: visible;
            opacity: 1;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #4facfe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: var(--spacing-lg);
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: var(--text-primary);
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        /* Network Graph */
        .network-graph {
            height: 400px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: var(--radius-lg);
            position: relative;
            overflow: hidden;
        }
        
        .network-graph svg {
            width: 100%;
            height: 100%;
        }
        
        /* Advanced Responsive Design */
        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-areas: 
                    "header header header"
                    "controls progress progress"
                    "realtime realtime realtime"
                    "analytics analytics analytics"
                    "network network network"
                    "results results results";
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-areas: 
                    "header"
                    "controls"
                    "progress"
                    "realtime"
                    "analytics"
                    "network"
                    "results";
                grid-template-columns: 1fr;
                padding: var(--spacing-md);
                gap: var(--spacing-md);
            }
            
            .results-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .phase-timeline {
                flex-direction: column;
                gap: var(--spacing-md);
            }
            
            .timeline-line {
                display: none;
            }
            
            .heading-1 {
                font-size: 2rem;
            }
        }
        
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .checkbox-group, .radio-group {
                flex-direction: column;
            }
            
            .notification {
                right: var(--spacing-md);
                left: var(--spacing-md);
                transform: translateY(-100px);
            }
            
            .notification.show {
                transform: translateY(0);
            }
        }
        
        /* Dark Mode Enhancements */
        @media (prefers-color-scheme: dark) {
            :root {
                --text-primary: #ffffff;
                --text-secondary: #e2e8f0;
                --text-muted: #94a3b8;
            }
        }
        
        /* Reduced Motion */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* High Contrast Mode */
        @media (prefers-contrast: high) {
            .card {
                border: 2px solid rgba(255, 255, 255, 0.8);
            }
            
            .btn {
                border: 2px solid currentColor;
            }
        }
        
        /* Enhanced Focus States */
        .btn:focus-visible,
        .form-control:focus-visible,
        .checkbox-item input:focus-visible,
        .radio-item input:focus-visible {
            outline: 2px solid #4facfe;
            outline-offset: 2px;
        }
        
        /* Print Styles */
        @media print {
            .notification,
            .loading-overlay {
                display: none !important;
            }
            
            .card {
                background: white !important;
                color: black !important;
                box-shadow: none !important;
                border: 1px solid #ccc !important;
            }
        }
        
        /* Custom Properties for Dynamic Themes */
        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #e2e8f0;
            --text-primary: #1a202c;
            --text-secondary: #4a5568;
            --text-muted: #718096;
            --glass-bg: rgba(255, 255, 255, 0.8);
            --glass-bg-strong: rgba(255, 255, 255, 0.9);
            --glass-border: rgba(0, 0, 0, 0.1);
        }
        
        /* Animation Performance Optimizations */
        .card,
        .btn,
        .activity-item,
        .result-item {
            will-change: transform;
        }
        
        .progress-fill,
        .timeline-progress {
            will-change: width;
        }
        
        /* Advanced Hover Effects */
        .card:hover .stat-number {
            animation: countUp 0.6s ease-out;
        }
        
        @keyframes countUp {
            from { 
                transform: scale(0.8);
                opacity: 0.5;
            }
            to { 
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Initializing Security Dashboard...</div>
    </div>
    
    <!-- Notification System -->
    <div class="notification" id="notification">
        <div class="flex items-center gap-2">
            <i class="fas fa-info-circle"></i>
            <div class="notification-content"></div>
        </div>
    </div>
    
    <!-- Main Dashboard -->
    <div class="container">
        <div class="dashboard-grid">
            <!-- Header Section -->
            <section class="header-section card card-elevated">
                <h1 class="heading-1">
                    <i class="fas fa-shield-alt"></i>
                    CywAyz Enterprise Security v2.0
                </h1>
                <p class="text-muted" style="font-size: 1.1rem; margin-bottom: var(--spacing-lg);">
                    Next-Generation AI-Powered API Vulnerability Scanner & Risk Analytics Platform
                </p>
                <div class="connection-status">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="connectionStatus">Connecting to Scanner...</span>
                </div>
            </section>
            
            <!-- Controls Section -->
            <section class="controls-section card">
                <h3 class="heading-3">
                    <i class="fas fa-cog"></i> Scan Configuration
                </h3>
                
                <div class="form-group">
                    <label class="form-label" for="targetUrl">
                        <i class="fas fa-crosshairs"></i> Target API URL
                    </label>
                    <input type="url" id="targetUrl" class="form-control" 
                           placeholder="https://api.example.com" 
                           value="https://jsonplaceholder.typicode.com">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="scanProfile">
                        <i class="fas fa-layer-group"></i> Scan Profile
                    </label>
                    <select id="scanProfile" class="form-control">
                        <option value="quick">‚ö° Quick Scan - Essential Checks</option>
                        <option value="standard" selected>üîç Standard - Comprehensive Analysis</option>
                        <option value="deep">üöÄ Deep Scan - Maximum Coverage</option>
                        <option value="custom">‚öôÔ∏è Custom - User Defined</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-search"></i> Discovery Methods
                    </label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="swaggerDiscovery" checked>
                            <span>üìã OpenAPI/Swagger</span>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="crawlDiscovery" checked>
                            <span>üï∑Ô∏è Intelligent Crawling</span>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="bruteForceDiscovery" checked>
                            <span>‚ö° Pattern Discovery</span>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="graphqlDiscovery">
                            <span>üîó GraphQL Schema</span>
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-4">
                    <button class="btn btn-primary btn-lg" id="startScan">
                        <i class="fas fa-rocket"></i> Launch Scan
                    </button>
                    <button class="btn btn-danger" id="stopScan" disabled>
                        <i class="fas fa-stop"></i> Stop
                    </button>
                    <button class="btn btn-outline" id="resetScan">
                        <i class="fas fa-redo"></i> Reset
                    </button>
                </div>
            </section>
            
            <!-- Progress Section -->
            <section class="progress-section card">
                <div class="flex justify-between items-center" style="margin-bottom: var(--spacing-lg);">
                    <h3 class="heading-3" style="margin-bottom: 0;">
                        <i class="fas fa-chart-line"></i> Scan Progress
                    </h3>
                    <div class="btn btn-sm btn-outline" id="timeRemaining">
                        <i class="fas fa-clock"></i> Ready
                    </div>
                </div>
                
                <!-- Phase Timeline -->
                <div class="phase-timeline">
                    <div class="timeline-line">
                        <div class="timeline-progress" id="timelineProgress"></div>
                    </div>
                    <div class="phase-item">
                        <div class="phase-icon" id="phaseDiscovery">üîç</div>
                        <div class="phase-label">Discovery</div>
                    </div>
                    <div class="phase-item">
                        <div class="phase-icon" id="phaseAuth">üîê</div>
                        <div class="phase-label">Authentication</div>
                    </div>
                    <div class="phase-item">
                        <div class="phase-icon" id="phaseVulns">üß™</div>
                        <div class="phase-label">Vulnerabilities</div>
                    </div>
                    <div class="phase-item">
                        <div class="phase-icon" id="phaseRisk">üìä</div>
                        <div class="phase-label">Risk Analysis</div>
                    </div>
                    <div class="phase-item">
                        <div class="phase-icon" id="phaseComplete">‚úÖ</div>
                        <div class="phase-label">Complete</div>
                    </div>
                </div>
                
                <!-- Progress Bar -->
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                
                <div class="text-center" style="margin-top: var(--spacing-md);">
                    <div id="progressPercentage" style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary);">0%</div>
                    <div id="progressMessage" class="text-muted">Ready to start security analysis</div>
                </div>
            </section>
            
            <!-- Real-time Activity Section -->
            <section class="realtime-section card">
                <h3 class="heading-3">
                    <i class="fas fa-history"></i> Live Activity Feed
                </h3>
                <div class="activity-feed" id="activityFeed">
                    <div class="activity-item">
                        <div class="activity-icon">üöÄ</div>
                        <div class="activity-content">
                            <div class="activity-message">Scanner initialized and ready for deployment</div>
                            <div class="activity-time" id="initTime"></div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Analytics Section -->
            <section class="analytics-section card">
                <h3 class="heading-3">
                    <i class="fas fa-chart-bar"></i> Security Analytics
                </h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="endpointsFound">0</div>
                        <div class="stat-label">API Endpoints</div>
                        <div class="stat-change positive" id="endpointsChange">+0 this scan</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="vulnerabilitiesFound">0</div>
                        <div class="stat-label">Vulnerabilities</div>
                        <div class="stat-change negative" id="vulnsChange">+0 this scan</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="riskScore">0</div>
                        <div class="stat-label">Risk Score</div>
                        <div class="stat-change" id="riskChange">0% change</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="scanDuration">0s</div>
                        <div class="stat-label">Scan Duration</div>
                        <div class="stat-change" id="durationChange">Real-time</div>
                    </div>
                </div>
                
                <!-- Chart Container -->
                <div style="margin-top: var(--spacing-xl);">
                    <h4 style="color: var(--text-primary); margin-bottom: var(--spacing-md);">
                        <i class="fas fa-chart-pie"></i> Vulnerability Distribution
                    </h4>
                    <div class="chart-container">
                        <canvas id="vulnerabilityChart" class="chart-canvas"></canvas>
                    </div>
                </div>

                <!-- New Radar Chart Container for Risk Categories -->
                <div style="margin-top: var(--spacing-xl);">
                    <h4 style="color: var(--text-primary); margin-bottom: var(--spacing-md);">
                        <i class="fas fa-compass"></i> Risk Category Radar
                    </h4>
                    <div class="chart-container">
                        <canvas id="radarChart" class="chart-canvas"></canvas>
                    </div>
                </div>

                <!-- New Heatmap Container for Endpoint Risks -->
                <div style="margin-top: var(--spacing-xl);">
                    <h4 style="color: var(--text-primary); margin-bottom: var(--spacing-md);">
                        <i class="fas fa-th-large"></i> Endpoint Risk Heatmap
                    </h4>
                    <div class="chart-container">
                        <svg id="heatmapSvg" class="chart-canvas"></svg>
                    </div>
                </div>
            </section>
            
            <!-- Network Visualization Section -->
            <section class="network-section card">
                <div class="flex justify-between items-center" style="margin-bottom: var(--spacing-lg);">
                    <h3 class="heading-3" style="margin-bottom: 0;">
                        <i class="fas fa-project-diagram"></i> API Network Map
                    </h3>
                    <div class="flex gap-2">
                        <button class="btn btn-sm btn-outline active" data-view="topology">Topology</button>
                        <button class="btn btn-sm btn-outline" data-view="security">Security</button>
                        <button class="btn btn-sm btn-outline" data-view="performance">Performance</button>
                    </div>
                </div>
                <div class="network-graph" id="networkGraph">
                    <svg width="100%" height="400"></svg>
                </div>
            </section>
            
            <!-- Results Section -->
            <section class="results-section card">
                <div class="flex justify-between items-center" style="margin-bottom: var(--spacing-lg);">
                    <h3 class="heading-3" style="margin-bottom: 0;">
                        <i class="fas fa-list-alt"></i> Scan Results
                    </h3>
                    <div class="flex gap-2">
                        <button class="btn btn-sm btn-primary" id="exportJSON">
                            <i class="fas fa-download"></i> JSON
                        </button>
                        <button class="btn btn-sm btn-primary" id="exportCSV">
                            <i class="fas fa-table"></i> CSV
                        </button>
                        <!-- <button class="btn btn-sm btn-secondary" id="clearResults">
                            <i class="fas fa-trash"></i> Clear
                        </button> -->
                    </div>
                </div>
                
                <div class="results-grid">
                    <div>
                        <h4 style="color: var(--text-primary); margin-bottom: var(--spacing-md);">
                            <i class="fas fa-bullseye"></i> Discovered Endpoints
                        </h4>
                        <div class="activity-feed" id="endpointsList">
                            <div class="result-item">
                                <div class="result-header">
                                    <div class="result-title">Initializing endpoint discovery...</div>
                                    <div class="result-badge medium">Pending</div>
                                </div>
                                <div class="result-description">Preparing to scan for API endpoints</div>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h4 style="color: var(--text-primary); margin-bottom: var(--spacing-md);">
                            <i class="fas fa-exclamation-triangle"></i> Security Findings
                        </h4>
                        <div class="activity-feed" id="vulnerabilitiesList">
                            <div class="result-item">
                                <div class="result-header">
                                    <div class="result-title">Initializing security analysis...</div>
                                    <div class="result-badge medium">Pending</div>
                                </div>
                                <div class="result-description">Preparing vulnerability assessment</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>
    
    <script>
        class CywAyzDashboard {
            constructor() {
                this.socket = null;
                this.isScanning = false;
                this.scanStartTime = null;
                this.currentScanId = null;
                this.endpoints = [];
                this.vulnerabilities = [];
                this.chart = null; // Doughnut chart for vulnerability distribution
                this.radarChart = null; // New radar chart for risk categories
                this.heatmapVisualization = null; // New heatmap visualization
                this.networkVisualization = null;
                this.scanTimer = null;

                this.dom = {
                    connectionStatus: document.getElementById('connectionStatus'),
                    statusDot: document.getElementById('statusDot'),
                    startScanBtn: document.getElementById('startScan'),
                    stopScanBtn: document.getElementById('stopScan'),
                    resetScanBtn: document.getElementById('resetScan'),
                    targetUrlInput: document.getElementById('targetUrl'),
                    scanDuration: document.getElementById('scanDuration'),
                    endpointsFound: document.getElementById('endpointsFound'),
                    vulnerabilitiesFound: document.getElementById('vulnerabilitiesFound'),
                    riskScore: document.getElementById('riskScore'),
                    activityFeed: document.getElementById('activityFeed'),
                    endpointsList: document.getElementById('endpointsList'),
                    vulnerabilitiesList: document.getElementById('vulnerabilitiesList'),
                    progressFill: document.getElementById('progressFill'),
                    progressMessage: document.getElementById('progressMessage'),
                    progressPercentage: document.getElementById('progressPercentage'),
                    timelineProgress: document.getElementById('timelineProgress')
                };
                this.currentNetworkView = 'topology'; // Default view
            }

            initialize() {
                    this.setupEventListeners();
                    this.initializeCharts();
                    this.initializeNetworkVisualization();
                this.initializeHeatmap(); // Initialize the heatmap
                this.connectWebSocket();
                this.updateNetworkVisualization();
                // Add export button handlers
                document.getElementById('exportJSON')?.addEventListener('click', () => this.downloadReport('json'));
                document.getElementById('exportCSV')?.addEventListener('click', () => this.downloadReport('csv'));
                // document.getElementById('exportPDF')?.addEventListener('click', () => this.downloadReport('pdf'));
            }

            // New method to initialize the heatmap
            initializeHeatmap() {
                const container = document.getElementById('heatmapSvg');
                if (!container) return;
                container.innerHTML = ''; // Clear existing content
                // Set up a scrollable wrapper for the SVG
                let scrollWrapper = document.getElementById('heatmapScrollWrapper');
                if (!scrollWrapper) {
                    scrollWrapper = document.createElement('div');
                    scrollWrapper.id = 'heatmapScrollWrapper';
                    scrollWrapper.style.overflowX = 'auto';
                    scrollWrapper.style.width = '100%';
                    scrollWrapper.style.height = '100%';
                    container.parentNode.insertBefore(scrollWrapper, container);
                    scrollWrapper.appendChild(container);
                }
                // Set a default width for now; will be updated in updateHeatmap
                const width = 800;
                const height = container.clientHeight || 200; // Default height for heatmap

                const svg = d3.select(container)
                    .attr("width", width)
                    .attr("height", height)
                    .attr("viewBox", [0, 0, width, height]);

                // Remove any previous zoom behavior
                svg.on('.zoom', null);

                // Create a group for zooming
                const g = svg.append("g").attr("class", "zoom-group");

                // Add D3 zoom behavior
                const zoom = d3.zoom()
                    .scaleExtent([1, 10]) // Allow 1x to 10x zoom
                    .translateExtent([[0, 0], [width, height]])
                    .on("zoom", (event) => {
                        g.attr("transform", event.transform);
                    });
                svg.call(zoom);

                this.heatmapVisualization = { container, svg, g, width, height, zoom };
            }

            async downloadReport(format) {
                if (!this.currentScanId) {
                    alert('No scan in progress. Please run a scan first.');
                    return;
                }
                try {
                    // Step 1: Request report generation
                    const response = await fetch(`/api/v1/reports/${this.currentScanId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ format })
                    });
                    const result = await response.json();
                    if (!result.success || !result.data?.downloadUrl) {
                        alert('Failed to generate report.');
                        return;
                    }
                    // Step 2: Download the report
                    const downloadUrl = result.data.downloadUrl;
                    const fileResponse = await fetch(downloadUrl);
                    if (!fileResponse.ok) {
                        alert('Failed to download report.');
                        return;
                    }
                    const blob = await fileResponse.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `cywayz-report-${this.currentScanId}.${format}`;
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(() => {
                        window.URL.revokeObjectURL(url);
                        a.remove();
                    }, 100);
                } catch (err) {
                    alert('Error generating or downloading report.');
                    console.error(err);
                }
            }

            connectWebSocket() {
                this.updateConnectionStatus('Connecting...', false);
                console.log('Attempting to connect WebSocket to http://localhost:3000...');
                this.socket = io('http://localhost:3000');
                        
                        this.socket.on('connect', () => {
                    console.log('WebSocket: Connected!');
                    this.updateConnectionStatus('Connected', true);
                    if (this.currentScanId) {
                        this.socket.emit('subscribe', this.currentScanId);
                    }
                });

                this.socket.on('disconnect', (reason) => {
                    console.log('WebSocket: Disconnected! Reason:', reason);
                    this.updateConnectionStatus('Disconnected', false);
                        });
                        
                        this.socket.on('connect_error', (error) => {
                    console.error('WebSocket: Connection Error!', error);
                    this.updateConnectionStatus(`Connection Error: ${error.message}`, false);
                });

                this.socket.on('error', (error) => {
                    console.error('WebSocket: Generic Error!', error);
                    this.updateConnectionStatus(`Error: ${error.message}`, false);
                });

                this.socket.on('scan-update', (data) => this.handleScanUpdate(data));
            }

            updateConnectionStatus(message, isConnected) {
                if (this.dom.connectionStatus) this.dom.connectionStatus.textContent = message;
                if (this.dom.statusDot) {
                    this.dom.statusDot.style.background = isConnected ? '#4CAF50' : '#ff6b6b';
                    this.dom.statusDot.style.animation = isConnected ? 'pulse 2s infinite' : 'none';
                }
            }
            
            setupEventListeners() {
                this.dom.startScanBtn.addEventListener('click', () => this.startScan());
                this.dom.stopScanBtn.addEventListener('click', () => this.stopScan());
                this.dom.resetScanBtn.addEventListener('click', () => this.resetScan());
                document.querySelectorAll('[data-view]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('[data-view]').forEach(b => b.classList.remove('active'));
                        e.currentTarget.classList.add('active');
                        this.switchNetworkView(e.currentTarget.dataset.view);
                    });
                });
            }
            
            async startScan() {
                if (this.isScanning) return;
                    this.isScanning = true;
                    this.updateScanButtons(true);
                this.resetScanState();
                this.scanStartTime = Date.now();
                
                this.scanTimer = setInterval(() => {
                    const duration = Math.floor((Date.now() - this.scanStartTime) / 1000);
                    if (this.dom.scanDuration) this.dom.scanDuration.textContent = `${duration}s`;
                }, 1000);

                const targetUrl = this.dom.targetUrlInput.value.trim();
                this.addActivity('üöÄ Scan Initiated', `Scanning ${targetUrl}`);
                
                try {
                    const response = await fetch('/api/v1/scans', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ target: { baseUrl: targetUrl }, scanConfig: { depth: 'comprehensive' } })
                    });
                    const result = await response.json();
                    this.currentScanId = result.scanId;
                    this.socket.emit('subscribe', this.currentScanId);
                } catch (error) {
                    this.addActivity('‚ùå Scan Failed', error.message);
                    this.stopScan();
                }
            }

            stopScan() {
                    this.isScanning = false;
                clearInterval(this.scanTimer);
                    this.updateScanButtons(false);
                this.addActivity('‚èπÔ∏è Scan Stopped', 'Scan terminated by user.');
            }

            updateScanButtons(isScanning) {
                this.dom.startScanBtn.disabled = isScanning;
                this.dom.stopScanBtn.disabled = !isScanning;
            }

            resetScanState() {
                this.endpoints = [];
                this.vulnerabilities = [];
                this.scanStartTime = null;
                clearInterval(this.scanTimer);
                if (this.dom.scanDuration) this.dom.scanDuration.textContent = '0s';
                this.updateStatistics();
                this.updateCharts();
                this.updateNetworkVisualization(); // Call without view, it will use currentNetworkView
                if(this.dom.activityFeed) this.dom.activityFeed.innerHTML = '';
                if(this.dom.endpointsList) this.dom.endpointsList.innerHTML = '';
                if(this.dom.vulnerabilitiesList) this.dom.vulnerabilitiesList.innerHTML = '';
                this.updateProgress(0, 'Ready to start security analysis.');
            }

            handleScanUpdate({ eventType, data: payload }) {
                switch (eventType) {
                    case 'progress':
                        this.updateProgress(payload.progress, payload.message);
                        break;
                    case 'endpoint_discovered':
                        this.addEndpoint(payload.endpoint);
                        break;
                    case 'vulnerability_found':
                        this.addVulnerability(payload.vulnerability);
                        break;
                    case 'scan_complete':
                        this.stopScan();
                        this.addActivity('‚úÖ Scan Complete', payload.message || 'Scan has finished.');
                        this.updateProgress(100, 'Scan Complete!');
                        break;
                    default:
                        this.addActivity(`‚ÑπÔ∏è ${eventType}`, payload.message || 'General update from scanner.');
                }
            }
            
            addEndpoint(endpoint) {
                if (!endpoint || !endpoint.url || this.endpoints.some(e => e.url === endpoint.url)) return;
                this.endpoints.push(endpoint);
                this.updateStatistics();
                this.updateNetworkVisualization();
                this.addToList(this.dom.endpointsList, `${endpoint.method || 'GET'} ${endpoint.url}`);
                this.addActivity('üîç Endpoint Found', `${endpoint.method || 'GET'} ${endpoint.url}`);
                this.updateHeatmap(); // Update heatmap when new endpoint is added
            }
            
            addVulnerability(vulnerability) {
                if (!vulnerability || !vulnerability.endpoint) return;
                this.vulnerabilities.push(vulnerability);
                this.updateStatistics();
                this.updateCharts();
                this.updateNetworkVisualization();
                // Add console log to inspect the vulnerability object
                console.log('Received vulnerability object:', vulnerability);
                this.addToList(this.dom.vulnerabilitiesList, this.createVulnerabilityItemHtml(vulnerability));
                this.addActivity('üö® Vulnerability Found', `${vulnerability.severity} - ${vulnerability.type}`);
                this.updateHeatmap(); // Update heatmap when new vulnerability is found
            }

            // Helper to create HTML for a vulnerability item, including remediation guidance
            createVulnerabilityItemHtml(vulnerability) {
                const severityClass = vulnerability.severity.toLowerCase();
                let remediationHtml = '';
                if (vulnerability.remediationGuidance) {
                    const { description, steps, references } = vulnerability.remediationGuidance;
                    remediationHtml = `
                        <details style="margin-top: var(--spacing-sm); background: rgba(255,255,255,0.05); padding: var(--spacing-sm); border-radius: var(--radius-sm);">
                            <summary style="font-weight: 600; cursor: pointer; color: var(--text-primary);">
                                <i class="fas fa-wrench" style="margin-right: 5px;"></i> Remediation Guidance
                            </summary>
                            <div style="padding-top: var(--spacing-sm); border-top: 1px solid rgba(255,255,255,0.1); margin-top: var(--spacing-sm);">
                                <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: var(--spacing-sm);">
                                    ${description}
                                </p>
                                ${steps && steps.length > 0 ? `
                                    <h5 style="color: var(--text-primary); margin-bottom: var(--spacing-xs); font-size: 0.9rem;">Steps:</h5>
                                    <ul style="list-style-type: decimal; margin-left: 1.25rem; font-size: 0.85rem; color: var(--text-secondary);">
                                        ${steps.map(step => `<li>${step}</li>`).join('')}
                                    </ul>
                                ` : ''}
                                ${references && references.length > 0 ? `
                                    <h5 style="color: var(--text-primary); margin-top: var(--spacing-sm); margin-bottom: var(--spacing-xs); font-size: 0.9rem;">References:</h5>
                                    <ul style="list-style-type: disc; margin-left: 1.25rem; font-size: 0.85rem; color: var(--text-secondary);">
                                        ${references.map(ref => `<li><a href="${ref}" target="_blank" style="color: #4facfe; text-decoration: none;">${ref}</a></li>`).join('')}
                                    </ul>
                                ` : ''}
                            </div>
                        </details>
                    `;
                }

                return `
                        <div class="result-header">
                        <div class="result-title">${vulnerability.type} at ${vulnerability.endpoint}</div>
                        <div class="result-badge ${severityClass}">${vulnerability.severity}</div>
                        </div>
                        <div class="result-description">
                        ${vulnerability.description || 'No description provided.'}
                        </div>
                    ${remediationHtml}
                `;
            }

            updateProgress(progress, message) {
                if (this.dom.progressFill) this.dom.progressFill.style.width = `${progress}%`;
                if (this.dom.progressMessage) this.dom.progressMessage.textContent = message;
                if (this.dom.progressPercentage) this.dom.progressPercentage.textContent = `${Math.round(progress)}%`;
                this.updatePhaseTimeline(this.getPhaseFromProgress(progress), progress);
            }
            
            getPhaseFromProgress(progress) {
                if (progress < 45) return 'discovery';
                if (progress < 60) return 'auth';
                if (progress < 80) return 'vulns';
                return 'complete';
            }
            
            updatePhaseTimeline(currentPhase, progress) {
                ['discovery', 'auth', 'vulns', 'risk', 'complete'].forEach(phase => {
                    const el = document.getElementById(`phase${phase.charAt(0).toUpperCase() + phase.slice(1)}`);
                    if (el) {
                        el.classList.remove('active', 'complete');
                        if (progress >= 100 && phase === 'complete') el.classList.add('complete');
                        else if (phase === currentPhase) el.classList.add('active');
                    }
                });
                if (this.dom.timelineProgress) this.dom.timelineProgress.style.width = `${progress}%`;
            }

            updateStatistics() {
                this.animateCounter(this.dom.endpointsFound, this.endpoints.length);
                this.animateCounter(this.dom.vulnerabilitiesFound, this.vulnerabilities.length);
                this.animateCounter(this.dom.riskScore, this.calculateRiskScore());
            }

            animateCounter(element, targetValue) {
                if (!element) return;
                const startValue = parseInt(element.textContent) || 0;
                const duration = 1000;
                let startTime = null;
                const step = (timestamp) => {
                    if (!startTime) startTime = timestamp;
                    const progress = Math.min((timestamp - startTime) / duration, 1);
                    element.textContent = Math.floor(progress * (targetValue - startValue) + startValue);
                    if (progress < 1) window.requestAnimationFrame(step);
                };
                window.requestAnimationFrame(step);
            }

            addToList(list, htmlContent) { // Changed text to htmlContent to accept full HTML
                const item = document.createElement('div');
                item.className = `result-item`; // Severity class is now handled inside htmlContent
                item.innerHTML = htmlContent; // Directly set innerHTML
                if (list && list.firstChild) list.insertBefore(item, list.firstChild);
                else if (list) list.appendChild(item);
            }
            
            addActivity(title, description) {
                const item = document.createElement('div');
                item.className = 'activity-item';
                item.innerHTML = `<div class="activity-icon">üí°</div><div class="activity-content"><div class="activity-message">${title}</div><div class="activity-time">${description}</div></div>`;
                if (this.dom.activityFeed && this.dom.activityFeed.firstChild) this.dom.activityFeed.insertBefore(item, this.dom.activityFeed.firstChild);
                else if (this.dom.activityFeed) this.dom.activityFeed.appendChild(item);
            }
            
            initializeCharts() {
                const ctx = document.getElementById('vulnerabilityChart')?.getContext('2d');
                if(!ctx) return;
                this.chart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Critical', 'High', 'Medium', 'Low'],
                        datasets: [{ data: [0, 0, 0, 0], backgroundColor: ['#ff6b6b', '#feca57', '#48dbfb', '#4CAF50'] }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });

                const radarCtx = document.getElementById('radarChart')?.getContext('2d');
                if(!radarCtx) return;
                this.radarChart = new Chart(radarCtx, {
                    type: 'radar',
                    data: {
                        labels: ['Critical', 'High', 'Medium', 'Low'],
                        datasets: [{
                            label: 'Risk Distribution',
                            data: [0, 0, 0, 0],
                            backgroundColor: 'rgba(255, 255, 255, 0.1)',
                            borderColor: 'rgba(255, 255, 255, 0.5)',
                            pointBackgroundColor: 'rgba(255, 255, 255, 0.7)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgba(179,181,198,1)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.2)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            }
                        }
                    }
                });
            }
            
            updateCharts() {
                if(!this.chart) return;
                const counts = this.vulnerabilities.reduce((acc, v) => { acc[v.severity] = (acc[v.severity] || 0) + 1; return acc; }, {});
                this.chart.data.datasets[0].data = [counts['CRITICAL'] || 0, counts['HIGH'] || 0, counts['MEDIUM'] || 0, counts['LOW'] || 0];
                this.chart.update();

                this.updateRadarChart(); // Call the new radar chart update method
            }

            // New method to update the radar chart based on risk categories
            updateRadarChart() {
                if (!this.radarChart) return;

                const riskCategories = {
                    'Injection': ['SQL_INJECTION', 'NOSQL_INJECTION', 'XSS', 'COMMAND_INJECTION', 'LDAP_INJECTION'],
                    'Sensitive Data Exposure': ['PII_EXPOSURE', 'SENSITIVE_DATA_EXPOSURE', 'INFORMATION_DISCLOSURE', 'FILE_EXPOSURE', 'DETAILED_ERROR_MESSAGES', 'EXPOSED_SENSITIVE_PATH_IN_ROBOTS_OR_SITEMAP'],
                    'Authentication & Access Control': ['NO_AUTHENTICATION', 'WEAK_AUTHENTICATION', 'BROKEN_ACCESS_CONTROL', 'ADMIN_PANEL_EXPOSED', 'HTTP_METHOD_ALLOWED_WITH_AUTH'],
                    'Misconfiguration': ['MISSING_SECURITY_HEADERS', 'CORS_MISCONFIGURATION', 'DEBUG_MODE_ENABLED', 'DIRECTORY_LISTING_ENABLED', 'SERVER_INFO_DISCLOSURE', 'X_POWERED_BY_HEADER_DISCLOSURE', 'MISSING_HSTS', 'TLS_CERT_HOSTNAME_MISMATCH', 'TLS_CERT_UNTRUSTED', 'MISSING_SECURE_COOKIE_FLAG', 'MISSING_HTTPONLY_COOKIE_FLAG', 'MISSING_SAMESITE_COOKIE_FLAG', 'PERMISSIVE_CORS_WITH_CREDENTIALS', 'PERMISSIVE_CORS', 'CSP_UNSAFE_INLINE', 'CSP_UNSAFE_EVAL', 'CSP_WEAK_DEFAULT_SRC', 'CSP_MISSING'],
                    'Business Logic & Rate Limiting': ['BUSINESS_LOGIC_FLAW', 'MASS_ASSIGNMENT', 'RACE_CONDITION', 'RATE_LIMITING_BYPASS'],
                    'HTTP Method Enforcement': ['UNSAFE_HTTP_METHOD_ALLOWED']
                };

                const categoryCounts = {};
                for (const category in riskCategories) {
                    categoryCounts[category] = 0;
                }

                this.vulnerabilities.forEach(vulnerability => {
                    for (const category in riskCategories) {
                        if (riskCategories[category].includes(vulnerability.type)) {
                            categoryCounts[category]++;
                            break; // Assign to first matching category
                        }
                    }
                });

                const labels = Object.keys(riskCategories);
                const data = labels.map(label => categoryCounts[label]);

                this.radarChart.data.labels = labels;
                this.radarChart.data.datasets[0].data = data;

                // Dynamically adjust the max value of the radar chart's radial scale
                const maxCount = Math.max(...data, 1); // Ensure it's at least 1 to avoid division by zero or flat line
                this.radarChart.options.scales.r.max = maxCount + (maxCount > 0 ? Math.ceil(maxCount * 0.1) : 5); // Add a 10% buffer or a minimum of 5 if maxCount is 0
                
                this.radarChart.update();
            }
            
            initializeNetworkVisualization() {
                const container = document.getElementById('networkGraph');
                if (!container) return;
                container.innerHTML = '';
                const width = container.clientWidth;
                const height = container.clientHeight || 500;
                const svg = d3.select(container).append("svg").attr("width", width).attr("height", height).attr("viewBox", [0, 0, width, height]);
                this.networkVisualization = { container, svg, g: svg.append("g"), width, height, simulation: d3.forceSimulation() };
            }

            updateNetworkVisualization() {
                if (!this.networkVisualization) return;
                const { g, width, height, simulation } = this.networkVisualization;
                g.selectAll('*').remove();

                if (this.endpoints.length === 0) {
                    g.append("text").attr("x", width / 2).attr("y", height / 2).attr("text-anchor", "middle").attr("fill", "rgba(255,255,255,0.7)").style("font-size", "16px").text("Scan to build network map");
                    return;
                }

                const nodes = [
                    { id: 'gateway', name: 'Gateway', type: 'gateway', risk: 'safe', performance: 0.8 },
                    ...this.endpoints.map(e => {
                        const endpointVulnerabilities = this.vulnerabilities.filter(v => v.endpoint === e.url);
                        return {
                            id: e.url,
                            name: e.url.split('/').pop() || 'endpoint',
                            type: 'endpoint',
                            risk: this.calculateEndpointRisk(endpointVulnerabilities),
                            performance: Math.random() // Placeholder for performance score (0-1)
                        };
                    })
                ];
                const links = this.endpoints.map(e => ({ source: 'gateway', target: e.url }));

                simulation.nodes(nodes)
                    .force("link", d3.forceLink(links).id(d => d.id).distance(150))
                    .force("charge", d3.forceManyBody().strength(-400))
                    .force("collide", d3.forceCollide().radius(25))
                    .force("center", d3.forceCenter(width / 2, height / 2));
                
                const riskColorScale = d3.scaleOrdinal()
                    .domain(['gateway', 'low', 'medium', 'high', 'critical'])
                    .range(['#74b9ff', '#4CAF50', '#48dbfb', '#feca57', '#ff6b6b']);

                const performanceColorScale = d3.scaleSequential(d3.interpolateViridis)
                    .domain([0, 1]); // 0 for bad performance (e.g., slow), 1 for good performance (e.g., fast)
                
                const nodeColor = (d) => {
                    if (d.type === 'gateway') return riskColorScale('gateway');
                    if (this.currentNetworkView === 'security') return riskColorScale(d.risk);
                    if (this.currentNetworkView === 'performance') return performanceColorScale(d.performance);
                    return riskColorScale('low'); // Default to topology view (green for new endpoints)
                };

                const nodeRadius = (d) => {
                    if (d.type === 'gateway') return 20;
                    // You can make radius dependent on risk or performance here too
                    return 12;
                };

                const linkStroke = (d) => {
                    // Future enhancement: vary link stroke based on data flow or security
                    return "#999";
                };

                const linkStrokeOpacity = (d) => {
                    // Future enhancement: vary link opacity based on data flow or security
                    return 0.6;
                };

                const link = g.append("g")
                    .attr("stroke", linkStroke)
                    .attr("stroke-opacity", linkStrokeOpacity)
                    .selectAll("line")
                    .data(links)
                    .join("line");

                const node = g.append("g")
                    .selectAll("circle")
                    .data(nodes)
                    .join("circle")
                    .attr("r", nodeRadius)
                    .attr("fill", nodeColor)
                    .call(this.drag(simulation));

                const labels = g.append("g")
                    .selectAll("text")
                    .data(nodes)
                    .join("text")
                    .text(d => d.name)
                    .attr("font-size", "10px")
                    .attr("fill", "white")
                    .attr("text-anchor", "middle")
                    .attr("dy", d => nodeRadius(d) + 12) // Position label below the node
                    .style("pointer-events", "none"); // Make labels non-interactive

                simulation.on("tick", () => {
                    link
                        .attr("x1", d => d.source.x)
                        .attr("y1", d => d.source.y)
                        .attr("x2", d => d.target.x)
                        .attr("y2", d => d.target.y);

                    node
                        .attr("cx", d => d.x)
                        .attr("cy", d => d.y);
                    
                    labels
                        .attr("x", d => d.x)
                        .attr("y", d => d.y + nodeRadius(d) + 12); // Keep labels below nodes
                });
                
                simulation.alpha(1).restart();
            }

            calculateEndpointRisk(vulnerabilities) {
                // Simple aggregation: find the highest severity among vulnerabilities for an endpoint
                const severities = vulnerabilities.map(v => v.severity);
                if (severities.includes('CRITICAL')) return 'critical';
                if (severities.includes('HIGH')) return 'high';
                if (severities.includes('MEDIUM')) return 'medium';
                if (severities.includes('LOW')) return 'low';
                return 'safe';
            }

            // Helper function to get color based on performance score (0-1)
            getPerformanceColor(score) {
                // Example: Green for high (good), Red for low (bad)
                if (score > 0.75) return '#4CAF50'; // Green
                if (score > 0.5) return '#feca57'; // Yellow/Orange
                if (score > 0.25) return '#48dbfb'; // Light Blue
                return '#ff6b6b'; // Red
            }

            switchNetworkView(view) {
                this.currentNetworkView = view;
                document.querySelectorAll('.network-graph button').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.view === view) {
                        btn.classList.add('active');
                    }
                });
                this.updateNetworkVisualization();
            }

            calculateRiskScore() {
                let totalScore = 0;
                const severityScores = {
                    'CRITICAL': 100,
                    'HIGH': 75,
                    'MEDIUM': 50,
                    'LOW': 25,
                    'INFO': 10 // Assuming INFO might exist for very low impact findings
                };

                this.vulnerabilities.forEach(vuln => {
                    totalScore += severityScores[vuln.severity] || 0;
                });

                // Normalize or cap the score if needed for display purposes (e.g., max 1000)
                return Math.min(totalScore, 1000);
            }
            
            getRiskColor(score) {
                if (score >= 800) return '#ff6b6b'; // Critical
                if (score >= 600) return '#feca57'; // High
                if (score >= 400) return '#48dbfb'; // Medium
                if (score >= 200) return '#4CAF50'; // Low
                return '#74b9ff'; // Info/Safe
            }

            getSeverityColor(severity) {
                switch (severity) {
                    case 'CRITICAL': return '#ff6b6b';
                    case 'HIGH': return '#feca57';
                    case 'MEDIUM': return '#48dbfb';
                    case 'LOW': return '#4CAF50';
                    default: return '#b3b3b3'; // Muted for unknown/info
                }
            }

            debounce(func, delay) {
                let timeout;
                return function(...args) {
                    const context = this;
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(context, args), delay);
                };
            }

            drag(simulation) {
                function dragstarted(event, d) {
                    if (!event.active) simulation.alphaTarget(0.3).restart();
                    d.fx = d.x;
                    d.fy = d.y;
                }

                function dragged(event, d) {
                    d.fx = event.x;
                    d.fy = event.y;
                }

                function dragended(event, d) {
                    if (!event.active) simulation.alphaTarget(0);
                    d.fx = null;
                    d.fy = null;
                }

                return d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended);
            }

            // New method to update the heatmap visualization
            updateHeatmap() {
                if (!this.heatmapVisualization) return;
                const { g, container, svg, height, zoom } = this.heatmapVisualization;
                g.selectAll('*').remove();

                if (this.endpoints.length === 0) {
                    g.append("text")
                        .attr("x", 400)
                        .attr("y", height / 2)
                        .attr("text-anchor", "middle")
                        .attr("fill", "rgba(255,255,255,0.7)")
                        .style("font-size", "14px")
                        .text("Scan to generate endpoint risk heatmap");
                    return;
                }

                // Prepare data for heatmap: map each endpoint to its risk score
                const heatmapData = this.endpoints.map((e, i) => {
                    const endpointVulnerabilities = this.vulnerabilities.filter(v => v.endpoint === e.url);
                    const risk = this.calculateEndpointRisk(endpointVulnerabilities);
                    return { url: e.url, risk: risk, index: i }; // Add index for xScale
                });

                // Dynamically set width based on number of endpoints
                const minBarWidth = 18;
                const width = Math.max(heatmapData.length * minBarWidth, 800); // At least 800px
                svg.attr("width", width).attr("viewBox", [0, 0, width, height]);
                this.heatmapVisualization.width = width;
                if (zoom) {
                    // Update zoom translateExtent to match new width
                    svg.call(zoom.transform, d3.zoomIdentity); // Reset zoom
                    zoom.translateExtent([[0, 0], [width, height]]);
                }

                // Define scales and colors
                const xScale = d3.scaleBand()
                    .range([0, width])
                    .domain(heatmapData.map(d => d.index)) // Use index as domain
                    .paddingInner(0.2); // Increased padding

                const riskHeightScale = d3.scaleOrdinal()
                    .domain(['low', 'medium', 'high', 'critical', 'safe'])
                    .range([0.2, 0.4, 0.6, 1.0, 0.1].map(h => h * height)); 

                const colorScale = d3.scaleOrdinal()
                    .domain(['low', 'medium', 'high', 'critical', 'safe'])
                    .range(['#4CAF50', '#48dbfb', '#feca57', '#ff6b6b', '#74b9ff']);

                // Draw rectangles for each endpoint
                const bars = g.selectAll("rect")
                    .data(heatmapData)
                    .join("rect")
                    .attr("x", d => xScale(d.index))
                    .attr("y", d => height - riskHeightScale(d.risk))
                    .attr("width", xScale.bandwidth())
                    .attr("height", d => riskHeightScale(d.risk))
                    .attr("fill", d => colorScale(d.risk));

                // Add text labels for each endpoint (show every Nth label for readability)
                const labelStep = Math.ceil(heatmapData.length / 20); // Show max 20 labels
                g.selectAll("text.endpoint-label")
                    .data(heatmapData)
                    .join("text")
                    .attr("class", "endpoint-label")
                    .attr("x", d => xScale(d.index) + xScale.bandwidth() / 2)
                    .attr("y", d => height - riskHeightScale(d.risk) - 5)
                    .attr("text-anchor", "middle")
                    .attr("fill", "white")
                    .style("font-size", "8px")
                    .text((d, i) => (i % labelStep === 0 ? (d.url.split('/').pop() || d.url) : ''))
                    .attr("transform", (d, i) => {
                        const x = xScale(d.index) + xScale.bandwidth() / 2;
                        const y = height - riskHeightScale(d.risk) - 5;
                        return i % labelStep === 0 ? `rotate(-90, ${x}, ${y})` : '';
                    });

                // Add tooltips (optional but highly recommended for detail)
                bars.append("title")
                    .text(d => `Endpoint: ${d.url}\nRisk: ${d.risk.toUpperCase()}`);
            }
        }

        // Initialize dashboard on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            const dashboard = new CywAyzDashboard();
            dashboard.initialize();
        });
    </script>
</body>
</html> 